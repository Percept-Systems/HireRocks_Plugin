<script>
    (function () {
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const searchParams = new URLSearchParams(window.location.search);

        // Salesforce sends CODE, not TOKEN
        const accessToken =
            hashParams.get("access_token") ||
            searchParams.get("accessToken") ||
            searchParams.get("code"); // <-- IMPORTANT FIX

        const platform =
            searchParams.get("platform") ||
            searchParams.get("source") ||
            "zoho";

        if (!accessToken) {
            console.error("No token/code found in redirect URL");
            window.close();
            return;
        }

        let type = "";
        if (platform === "zoho") type = "ZOHO_TOKEN";
        else if (platform === "salesforce") type = "SF_TOKEN";  // returns CODE
        else type = "OAUTH_TOKEN";

        const origin = searchParams.get("origin") || "*";

        // Send message to opener (CRM TAB)
        window.opener.postMessage(
            { type, token: accessToken },
            origin
        );

        window.close();
    })();
</script>