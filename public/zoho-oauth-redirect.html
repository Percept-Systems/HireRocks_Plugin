<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>OAuth Redirect</title>
</head>

<body>
    <script>
        (function () {
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const searchParams = new URLSearchParams(window.location.search);

            // ZOHO (Implicit flow) → access_token
            const accessToken =
                hashParams.get("access_token") ||
                searchParams.get("accessToken");

            // SALESFORCE (Auth code flow) → code
            const authCode = searchParams.get("code");

            const platform =
                searchParams.get("platform") ||
                searchParams.get("source") ||
                (authCode ? "salesforce" : "zoho");

            let type = "";
            let tokenToSend = "";

            if (platform === "zoho" && accessToken) {
                type = "ZOHO_TOKEN";
                tokenToSend = accessToken;
            }
            else if (platform === "salesforce" && authCode) {
                type = "SF_CODE"; // IMPORTANT FIX
                tokenToSend = authCode;
            }
            else {
                console.error("No valid token or code found for OAuth.");
                window.close();
                return;
            }

            const origin = searchParams.get("origin") || window.location.origin;

            window.opener.postMessage(
                { type, token: tokenToSend },
                origin
            );

            window.close();
        })();
    </script>
</body>

</html>